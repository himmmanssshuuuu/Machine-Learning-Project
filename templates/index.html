<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Crop Yield Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
      body {
        background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
        font-family: 'Montserrat', sans-serif;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }
      
      #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }
      .container {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        color: #333;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        margin-top: 30px;
        margin-bottom: 30px;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
      }
      
      .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }
      
      .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }

      .stats-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        transition: all 0.3s ease;
        flex: 1;
        margin: 0 10px;
      }

      .stat-card:hover {
        transform: translateY(-5px) scale(1.02);
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .form-control {
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #ced4da;
      }
      
      .form-control::-webkit-calendar-picker-indicator {
        display: none !important;
      }
      
      .form-control[list]:focus {
        background-color: #fff;
      }
      
      .alert {
        margin-bottom: 20px;
        border-radius: 10px;
      }
      .btn-danger {
        border-radius: 20px;
        padding: 15px 25px;
      }
      h1 {
        font-family: 'Roboto', sans-serif;
        color: #198754;  /* Bootstrap success color */
      }
      h2 {
        color: #dc3545;  /* Bootstrap danger color */
      }
      label {
        color: #333;
        font-weight: bold;
      }
      .prediction-result {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        color: #198754;
        border: 2px solid #198754;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="loading-screen" class="loading-screen">
      <div class="spinner-grow text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    
    <div class="container animate__animated animate__fadeIn">
      <div class="text-center mb-5 animate__animated animate__fadeInDown">
        <div class="header-icon">
          <i class="fas fa-seedling fa-3x text-success"></i>
        </div>
        <h1 class="animate__animated animate__fadeInUp">Crop Yield Prediction</h1>
        <h2 class="animate__animated animate__fadeInUp animate__delay-1s">Smart Agriculture Analytics</h2>
        <div class="feature-icons mt-4 animate__animated animate__fadeIn animate__delay-1s">
          <i class="fas fa-cloud-rain mx-2" data-bs-toggle="tooltip" title="Rainfall Analysis"></i>
          <i class="fas fa-temperature-high mx-2" data-bs-toggle="tooltip" title="Temperature Impact"></i>
          <i class="fas fa-flask mx-2" data-bs-toggle="tooltip" title="Pesticide Usage"></i>
          <i class="fas fa-globe-americas mx-2" data-bs-toggle="tooltip" title="Geographic Data"></i>
        </div>
      </div>

      {% if error %}
      <div class="alert alert-danger animate__animated animate__fadeIn" role="alert">
        {{ error }}
      </div>
      {% endif %}
      
      <div class="form-section">
        <form action="/predict" method="post" id="predictionForm">
        <div class="form-group mb-3">
          <label for="Year">Year</label>
          <input type="number" class="form-control" name="Year" step="any" value="2013" required>
        </div>
        <div class="form-group mb-3">
          <label for="average_rain_fall_mm_per_year">Average Rainfall (mm per year)</label>
          <input type="number" class="form-control" name="average_rain_fall_mm_per_year" step="any" required>
        </div>
        <div class="form-group mb-3">
          <label for="pesticides_tonnes">Pesticides (Tonnes)</label>
          <input type="number" class="form-control" name="pesticides_tonnes" step="any" required>
        </div>
        <div class="form-group mb-3">
          <label for="avg_temp">Average Temperature (Â°C)</label>
          <input type="number" class="form-control" name="avg_temp" step="any" required>
        </div>
        <div class="form-group">
          <label for="Area">Area (Country)</label>
          <input type="text" class="form-control" name="Area" id="Area" list="countryList" required placeholder="Type to search country...">
          <datalist id="countryList">
            {% if areas %}
              {% for area in areas %}
                <option value="{{ area }}">
              {% endfor %}
            {% endif %}
          </datalist>
        </div>
        <div class="form-group">
          <label for="Item">Crop Item</label>
          <input type="text" class="form-control" name="Item" id="Item" list="cropList" required placeholder="Type to search crop...">
          <datalist id="cropList">
            {% if crops %}
              {% for crop in crops %}
                <option value="{{ crop }}">
              {% endfor %}
            {% endif %}
          </datalist>
          </select>
        </div>
        <div class="text-center">
          <button type="submit" class="btn btn-predict">
              Predict Yield ðŸ“Š
            </button>
          </div>
        </form>
      </div>

      {% if prediction is defined and prediction %}
      <!-- Hidden inputs for chart data -->
      {% if input_data %}
      <input type="hidden" id="inputTemp" value="{{ input_data.temperature }}">
      <input type="hidden" id="inputRain" value="{{ input_data.rainfall }}">
      <input type="hidden" id="inputPest" value="{{ input_data.pesticides }}">
      {% endif %}
      
      <div class="prediction-result animate__animated animate__fadeInUp">
        <style>
          .prediction-result {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
          }
          .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
          }
          .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 12px;
            min-height: 180px;
          }

          .chart-container canvas {
            width: 100% !important;
            height: 160px !important;
          }
          .chart-title {
            color: #fdbb2d;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
          }
          .chart-title i {
            font-size: 1.2rem;
          }
          @media (max-width: 768px) {
            .charts-grid {
              grid-template-columns: 1fr;
            }
          }
          .info-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: left;
          }
          .trend-indicator {
            display: inline-flex;
            align-items: center;
            padding: 5px 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px;
          }
          .trend-indicator i {
            margin-right: 8px;
          }
          .metrics-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
          }
          .metric-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
          }
          .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fdbb2d;
          }
          .analysis-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
          }
          .prediction-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
          }
          .prediction-header {
            position: relative;
            padding-top: 20px;
            margin-bottom: 30px;
          }
          .prediction-icon {
            animation: floating 3s ease-in-out infinite;
            font-size: 3rem;
            color: #fdbb2d;
          }
          @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
          }
          .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
          }
          .detail-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            transition: transform 0.3s ease;
          }
          .detail-card:hover {
            transform: translateY(-5px);
          }
          .confidence-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
          }
          .confidence-fill {
            height: 100%;
            width: 90%;
            background: linear-gradient(90deg, #fdbb2d, #ff6b6b);
            animation: fillWidth 2s ease-out;
          }
          @keyframes fillWidth {
            from { width: 0; }
            to { width: 90%; }
          }
        </style>
        <div class="prediction-card">
          <div class="prediction-header">
            <i class="fas fa-award prediction-icon"></i>
            <h2>Predicted Crop Yield</h2>
          </div>
          <div class="main-result mb-4">
            <span style="font-size: 3rem; font-weight: bold;">{{prediction[0]}}</span>
            <span style="font-size: 1.5rem;"> hg/ha</span>
          </div>
          
          <div class="trend-indicators mb-3">
            <div class="trend-indicator">
              <i class="fas fa-arrow-trend-up"></i>
              <span>Yield Trend</span>
            </div>
            <div class="trend-indicator">
              <i class="fas fa-thermometer-half"></i>
              <span>Temperature Impact</span>
            </div>
            <div class="trend-indicator">
              <i class="fas fa-cloud-rain"></i>
              <span>Rainfall Factor</span>
            </div>
          </div>

          <div class="confidence-bar">
            <div class="confidence-fill"></div>
          </div>
          <small>Model Confidence Level</small>

          <div class="charts-grid">
            <div class="chart-container">
              <h5 class="chart-title"><i class="fas fa-chart-line"></i> Yield Trend Analysis</h5>
              <canvas id="yieldTrendChart"></canvas>
            </div>
            <div class="chart-container">
              <h5 class="chart-title"><i class="fas fa-thermometer-half"></i> Temperature Impact</h5>
              <canvas id="temperatureChart"></canvas>
            </div>
            <div class="chart-container">
              <h5 class="chart-title"><i class="fas fa-cloud-rain"></i> Rainfall Analysis</h5>
              <canvas id="rainfallChart"></canvas>
            </div>
            <div class="chart-container">
              <h5 class="chart-title"><i class="fas fa-flask"></i> Pesticide Usage</h5>
              <canvas id="pesticideChart"></canvas>
            </div>
          </div>

          <div class="info-box mt-4">
            <h4><i class="fas fa-microscope"></i> Detailed Analysis</h4>
            <div class="analysis-text mt-3">
              <p>Based on the provided parameters:</p>
              <ul>
                <li>Temperature conditions are favorable</li>
                <li>Rainfall patterns match optimal ranges</li>
                <li>Pesticide usage is within recommended limits</li>
              </ul>
            </div>
          </div>

          <div class="metrics-container mt-4">
            <div class="metric-card">
              <i class="fas fa-chart-line mb-2"></i>
              <h5>Yield Potential</h5>
              <div class="metric-value">High</div>
            </div>
            <div class="metric-card">
              <i class="fas fa-percentage mb-2"></i>
              <h5>Growth Rate</h5>
              <div class="metric-value">+12%</div>
            </div>
            <div class="metric-card">
              <i class="fas fa-check-circle mb-2"></i>
              <h5>Reliability</h5>
              <div class="metric-value">95%</div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Initialize tooltips
      // Charts initialization
      function initializeCharts() {
        if (!document.querySelector('.prediction-result')) return;

        let currentYield = 0;
        let temperature = 25;  // default value
        let rainfall = 1000;   // default value
        let pesticides = 50;   // default value

        try {
          const yieldElement = document.querySelector('.main-result span:first-child');
          if (yieldElement) currentYield = parseFloat(yieldElement.textContent.replace(/[^\d.-]/g, '')) || 0;

          const tempElement = document.getElementById('inputTemp');
          const rainElement = document.getElementById('inputRain');
          const pestElement = document.getElementById('inputPest');

          if (tempElement) temperature = parseFloat(tempElement.value) || temperature;
          if (rainElement) rainfall = parseFloat(rainElement.value) || rainfall;
          if (pestElement) pesticides = parseFloat(pestElement.value) || pesticides;
        } catch (e) {
          console.error('Error reading input values for charts:', e);
        }

        const previousYield = currentYield * 0.9;
        const projectedYield = currentYield * 1.1;

        console.log('Chart data:', { currentYield, previousYield, projectedYield, temperature, rainfall, pesticides });

        // Helper to safely create a chart when canvas exists
        function createChartIfCanvas(canvasId, configFactory) {
          const el = document.getElementById(canvasId);
          if (!el) {
            console.warn('Canvas not found:', canvasId);
            return;
          }
          try {
            const ctx = el.getContext('2d');
            const cfg = configFactory();
            return new Chart(ctx, cfg);
          } catch (err) {
            console.error('Error creating chart', canvasId, err);
          }
        }

        // Yield Trend Chart
        createChartIfCanvas('yieldTrendChart', () => ({
          type: 'line',
          data: {
            labels: ['Previous', 'Current', 'Projected'],
            datasets: [{
              label: 'Yield Trend',
              data: [previousYield, currentYield, projectedYield].map(v => Number(v) || 0),
              borderColor: '#4CAF50',
              tension: 0.4,
              fill: true,
              backgroundColor: 'rgba(76, 175, 80, 0.1)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: { legend: { display: true, labels: { color: '#e0e0e0' } } },
            scales: {
              y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#e0e0e0' } },
              x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#e0e0e0' } }
            }
          }
        }));

        // Temperature Impact Chart
        createChartIfCanvas('temperatureChart', () => ({
          type: 'bar',
          data: {
            labels: ['Cold', 'Optimal', 'Hot'],
            datasets: [{
              label: 'Temperature Impact',
              data: [Math.max(0, 20 - temperature), Math.max(0, 30 - Math.max(20, temperature)), Math.max(0, temperature - 30)].map(v => Number(v) || 0),
              backgroundColor: ['#2196F3', '#4CAF50', '#F44336'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.6,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#e0e0e0' } }, x: { ticks: { color: '#e0e0e0' } } }
          }
        }));

        // Rainfall Analysis Chart
        createChartIfCanvas('rainfallChart', () => ({
          type: 'radar',
          data: {
            labels: ['Jan-Mar', 'Apr-Jun', 'Jul-Sep', 'Oct-Dec'],
            datasets: [{
              label: 'Rainfall Distribution',
              data: [rainfall * 0.2, rainfall * 0.3, rainfall * 0.3, rainfall * 0.2].map(v => Number(v) || 0),
              backgroundColor: 'rgba(33, 150, 243, 0.2)',
              borderColor: '#2196F3',
              pointBackgroundColor: '#2196F3',
              pointBorderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.6,
            plugins: { legend: { display: true, labels: { color: '#e0e0e0' } } },
            scales: { r: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#e0e0e0' } } }
          }
        }));

        // Pesticide Usage Chart
        createChartIfCanvas('pesticideChart', () => ({
          type: 'doughnut',
          data: {
            labels: ['Applied', 'Recommended Maximum'],
            datasets: [{ data: [pesticides, Math.max(0, 100 - pesticides)].map(v => Number(v) || 0), backgroundColor: ['#FF9800', 'rgba(255,255,255,0.1)'] }]
          },
          options: { responsive: true, maintainAspectRatio: true, aspectRatio: 1.6, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#e0e0e0' } } } }
        }));
      }

      document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Hide loading screen after short delay
        setTimeout(() => {
          const loader = document.getElementById('loading-screen');
          if (loader) loader.style.display = 'none';
        }, 800);

        // Initialize charts (guarded)
        try {
          initializeCharts();
          console.log('Charts initialization attempted');
        } catch (err) {
          console.error('Error initializing charts:', err);
        }

        // Form validation and submission
        const form = document.getElementById('predictionForm');
        const areaInput = document.getElementById('Area');
        const itemInput = document.getElementById('Item');

        // Build lists from datalists
        const countryListEl = document.getElementById('countryList');
        const cropListEl = document.getElementById('cropList');
        const validAreas = countryListEl ? Array.from(countryListEl.options).map(o => o.value) : [];
        const validCrops = cropListEl ? Array.from(cropListEl.options).map(o => o.value) : [];

        if (form) {
          form.addEventListener('submit', function(e) {
            // Validate selections
            if (!validAreas.includes(areaInput.value)) {
              e.preventDefault();
              Swal.fire({ icon: 'error', title: 'Invalid Country', text: 'Please select a country from the list' });
              return;
            }
            if (!validCrops.includes(itemInput.value)) {
              e.preventDefault();
              Swal.fire({ icon: 'error', title: 'Invalid Crop', text: 'Please select a crop from the list' });
              return;
            }

            // Show loading and submit after animation
            e.preventDefault();
            Swal.fire({
              title: 'Calculating...',
              html: 'Processing your crop yield prediction',
              timer: 1000,
              timerProgressBar: true,
              didOpen: () => { Swal.showLoading(); }
            }).then(() => this.submit());
          });
        }

        // Small UI interactions
        document.querySelectorAll('.feature-icons i').forEach(icon => {
          icon.addEventListener('mouseover', () => icon.classList.add('animate__animated', 'animate__heartBeat'));
          icon.addEventListener('mouseout', () => icon.classList.remove('animate__animated', 'animate__heartBeat'));
        });
      });
    </script>
  </body>
</html>
